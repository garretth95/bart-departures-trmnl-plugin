<div class="layout layout--col layout--top layout--stretch">
    <div class="columns">
        <div class="column">

            {% assign dir = trmnl.plugin_settings.custom_fields_values.dir %}
            {% assign limit = 8 %}

            {%- comment -%}
            Recommended: store "code|name" in the select value, e.g. "900309|MacArthur"
            {%- endcomment -%}
            {% assign stop_parts = trmnl.plugin_settings.custom_fields_values.stopcode | split: "|" %}
            {% assign stopcode = stop_parts[0] %}
            {% assign stopname = stop_parts[1] | default: "BART" %}

            {% assign visits = ServiceDelivery.StopMonitoringDelivery.MonitoredStopVisit %}
            {% if visits == nil or visits == empty %}
            {% assign visits = ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit %}
            {% endif %}

            <span class="title title--large">{{ stopname }} BART</span>
            <div class="divider"></div>

            {% if visits and visits.size > 0 %}

            <table class="table table--base" data-table-limit="true">
                <thead>
                <tr>
                    <th><span class="title title--small">Destination</span></th>
                    <th><span class="title title--small">Line</span></th>
                    <th><span class="title title--small text--right">Departs</span></th>
                </tr>
                </thead>

                <tbody>
                {% assign shown = 0 %}

                {% for v in visits %}
                {% assign D = v.MonitoredVehicleJourney %}

                {%- comment -%}
                Filter out "ghost" entries: require LineRef, and then apply direction filter.
                Liquid precedence is weird; do it nested to be safe.
                {%- endcomment -%}
                {% if D.LineRef %}
                {% if dir == "" or D.DirectionRef == dir %}

                {% assign t = D.MonitoredCall.ExpectedDepartureTime %}
                {% if t == nil or t == "" %}
                {% assign t = D.MonitoredCall.ExpectedArrivalTime %}
                {% endif %}

                <tr>
                    <td>
                      <span class="label" data-clamp="1">
                        {{ D.MonitoredCall.DestinationDisplay }}
                      </span>
                    </td>
                    <td>
                      <span class="label label--small">
                        {{ D.LineRef }}
                      </span>
                    </td>
                    <td>
                      <span class="label label--small text--right">
                        {{ t | date: "%s" | plus: 0 | minus: 28800 | date: "%-I:%M %p" }}
                      </span>
                    </td>
                </tr>

                {% assign shown = shown | plus: 1 %}
                {% if shown >= limit %}
                {% break %}
                {% endif %}

                {% endif %}
                {% endif %}
                {% endfor %}
                </tbody>
            </table>

            {% else %}
            <span class="label">No upcoming trains</span>
            {% endif %}

        </div>
    </div>
</div>
